<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Desktop Provisioner</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    form, table { margin-top: 16px; }
    input, select, button { padding: 8px; margin: 4px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>Create Desktop</h2>
  <form id="f">
    <input name="image" value="accetto/ubuntu-vnc-xfce" placeholder="image" />
    <input name="internalPort" value="6080" placeholder="internalPort" />
    <input name="cpu" value="1" placeholder="cpu (cores)" />
    <input name="ramMb" value="1024" placeholder="ramMb" />
    <input name="name" placeholder="name (optional)" />
    <button type="submit">Create</button>
  </form>

  <h2>Instances</h2>
  <table id="t">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Image</th>
        <th>State</th>
        <th>URL</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const api = location.origin.replace(/\/$/, '').replace(/:\d+$/, '') + ':3001';

    async function refresh() {
      const res = await fetch(api + '/instances');
      const items = await res.json();
      const tbody = document.querySelector('#t tbody');
      tbody.innerHTML = '';
      for (const it of items) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.id || '-'}</td>
          <td>${it.name || '-'}</td>
          <td>${it.image}</td>
          <td>${it.state}</td>
          <td>${it.url ? `<a href="${it.url}" target="_blank">Open</a>` : '-'}</td>
          <td>
            <button data-id="${it.id}" data-a="start">Start</button>
            <button data-id="${it.id}" data-a="stop">Stop</button>
            <button data-id="${it.id}" data-a="restart">Restart</button>
            <button data-id="${it.id}" data-a="delete">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    document.getElementById('f').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      data.cpu = Number(data.cpu);
      data.ramMb = Number(data.ramMb);
      data.internalPort = Number(data.internalPort);
      const res = await fetch(api + '/instances', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!res.ok) alert('create failed');
      await refresh();
    });

    document.querySelector('#t').addEventListener('click', async (e) => {
      const b = e.target.closest('button');
      if (!b) return;
      const id = b.dataset.id;
      const a = b.dataset.a;
      if (a === 'delete') {
        await fetch(api + '/instances/' + id, { method: 'DELETE' });
      } else {
        await fetch(api + `/instances/${id}/${a}`, { method: 'POST' });
      }
      await refresh();
    });

    refresh();
  </script>
</body>
</html>

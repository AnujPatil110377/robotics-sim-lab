<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Desktop Provisioner</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; }
    form, table { margin-top: 16px; }
    input, select, button { padding: 8px; margin: 4px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <h2>Create Desktop</h2>
  <form id="f">
    <input name="image" value="accetto/ubuntu-vnc-xfce" placeholder="image" />
    <input name="internalPort" value="6901" placeholder="internalPort" />
    <input name="cpu" value="1" placeholder="cpu (cores)" />
    <input name="ramMb" value="1024" placeholder="ramMb" />
    <input name="name" placeholder="name (optional)" />
  <input name="crdEmail" placeholder="CRD email (optional)" />
  <input name="crdCode" placeholder="CRD auth code (optional)" />
  <!-- PIN input: use password type + numeric inputmode and validation (at least 6 digits) -->
  <input type="password" name="crdPassword" placeholder="CRD PIN (optional, 6 digits)" inputmode="numeric" pattern="\\d{6,}" minlength="6" />
    <!-- GPU selection removed: the provisioner does not enforce or assign GPUs -->
    <button type="submit">Create</button>
  </form>

  <p style="font-size: 0.9em; color: #444;">
    Tip: Generate Chrome Remote Desktop credentials at
    <a href="https://remotedesktop.google.com/headless" target="_blank" rel="noopener noreferrer">remotedesktop.google.com/headless</a>.
    Provide the CRD email and auth code to register the container automatically.
  </p>

  <h2>Instances</h2>
  <table id="t">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Image</th>
        <th>State</th>
  <th>Access</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const api = location.origin.replace(/\/$/, '').replace(/:\d+$/, '') + ':3001';

    async function refresh() {
      const res = await fetch(api + '/instances');
      const items = await res.json();
      const tbody = document.querySelector('#t tbody');
      tbody.innerHTML = '';
      for (const it of items) {
        const tr = document.createElement('tr');
        const accessCell = it.url
          ? `<a href="${it.url}" target="_blank">Open</a>`
          : it.crdAccessUrl
          ? `<div><a href="${it.crdAccessUrl}" target="_blank">Open Chrome Remote Desktop</a>${it.crdEmail ? `<br/><small>Account: ${it.crdEmail}</small>` : ''}</div>`
          : '-';
        tr.innerHTML = `
          <td>${it.id || '-'}</td>
          <td>${it.name || '-'}</td>
          <td>${it.image}</td>
          <td>${it.state}</td>
          <td>${accessCell}</td>
          <td>
            <button data-id="${it.id}" data-a="start">Start</button>
            <button data-id="${it.id}" data-a="stop">Stop</button>
            <button data-id="${it.id}" data-a="restart">Restart</button>
            <button data-id="${it.id}" data-a="delete">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      }
    }

    document.getElementById('f').addEventListener('submit', async (e) => {
      e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());
  data.cpu = Number(data.cpu);
  data.ramMb = Number(data.ramMb);
  const internalPortRaw = (data.internalPort || '').trim();
  data.internalPort = internalPortRaw ? Number(internalPortRaw) : undefined;
  if (data.internalPort === undefined) delete data.internalPort;
      const crdEmail = (data.crdEmail || '').trim();
      const crdCode = (data.crdCode || '').trim();
      const crdPassword = (data.crdPassword || '').trim();

      // Basic client-side validation: if a PIN is provided it must be numeric and at least 6 digits.
      if (crdPassword && !/^\d{6,}$/.test(crdPassword)) {
        alert('CRD PIN must be numeric and at least 6 digits long');
        return;
      }

      delete data.crdEmail;
      delete data.crdCode;
      delete data.crdPassword;
      if (crdEmail || crdCode || crdPassword) {
        data.crd = {};
        if (crdEmail) data.crd.email = crdEmail;
        if (crdCode) data.crd.code = crdCode;
        if (crdPassword) data.crd.password = crdPassword;
      }
      if (!data.gpu || data.gpu.trim() === '') delete data.gpu; // omit if not set
      const res = await fetch(api + '/instances', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!res.ok) alert('create failed');
      await refresh();
    });

    document.querySelector('#t').addEventListener('click', async (e) => {
      const b = e.target.closest('button');
      if (!b) return;
      const id = b.dataset.id;
      const a = b.dataset.a;
      if (a === 'delete') {
        await fetch(api + '/instances/' + id, { method: 'DELETE' });
      } else {
        await fetch(api + `/instances/${id}/${a}`, { method: 'POST' });
      }
      await refresh();
    });

    refresh();
  </script>
</body>
</html>
